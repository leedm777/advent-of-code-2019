(ns advent-of-code-2019.day17
  (:require [clojure.string :as s]
            [advent-of-code-2019.int-code :refer :all]))

(def up [0 -1])
(def down [0 1])
(def left [-1 0])
(def right [1 0])

(def all-dirs [up down left right])

(def scaffold \#)
(def open \.)
(def bot #{\^ \v \< \>})

(defn move
  [pos dir]
  (mapv + pos dir))

(defn plot-line
  [y line]
  (->> line
       (map-indexed (fn [x ch]
                      (if (s/includes? "#^v<>" (str ch))
                        [[x y] ch])))
       (mapcat identity)))

(defn plot-map
  [screen]
  (->> screen
       (map-indexed plot-line)
       (mapcat identity)
       (filter some?)
       (apply hash-map)))

(defn find-intersections
  [plot]
  (->> plot
       (filter (fn [[pos ch]]
                 (->> all-dirs
                      (mapv #(move pos %))
                      (every? #(contains? plot %)))))))

(defn sum-alignment-params
  [intersections]
  (->> intersections
       (map first)
       (map (fn [[x y]] (* x y)))
       (apply +)))

(defn init-robot
  [program]
  (let [brain (int-code program)
        [screen-ascii brain] (int-read-all-output brain)
        screen (s/split-lines (s/join (map char screen-ascii)))]
    {:brain brain
     :screen screen
     :map (plot-map screen)}))

(defn program-robot
  [robot movement]
  (let [brain (:brain robot)
        brain (int-resume-input brain movement)
        [output brain] (int-read-all-output brain)
        [screen-ascii total-dust] (partition-by #(< % 128) output)
        screen (s/split-lines (s/join (map char screen-ascii)))]
    (merge robot {:brain brain
                  :screen screen
                  :total-dust total-dust})))

(def movement-program
  (map int
       (s/join "\n"
               ;; 20 character limit per line
               ["A,A,B,A,C" ;; 10 instructions
                "R,12,L,6"
                "2,L,6,L,10"
                "0"
                "n"
                ""])))

(defn solve
  [input]
  (let [program (int-parse input)
        ;;robot (init-robot program)
        woke-robot (init-robot (assoc program 0 2))
        working-robot (program-robot woke-robot movement-program)]
    (println (int-halted? (:brain working-robot)))
    {
     ;; :sum-alignment-params (->> robot
     ;;                            (:map)
     ;;                            (find-intersections)
     ;;                            (sum-alignment-params))
     :final-pos (:screen working-robot)
     :total-dust (:total-dust working-robot)}))

(def full-screen
  ["....#########......................................"
   "....#.......#......................................"
   "....#.......#......................................"
   "....#.......#......................................"
   "....#.......#......................................"
   "....#.......#......................................"
   "....###########...................................."
   "............#.#...................................."
   "............#.#...................................."
   "............#.#...................................."
   "............#######................................"
   "..............#...#................................"
   "..............#...#.....###########.........#######"
   "..............#...#.....#.........#.........#.....#"
   "..............#...#.....#.........#.........#.....#"
   "..............#...#.....#.........#.........#.....#"
   "..........###########...#.........#.........#.....#"
   "..........#...#...#.#...#.........#.........#.....#"
   "..........#...###########.........#.........#.....#"
   "..........#.......#.#.............#.........#.....#"
   "......#############.#.............#...#############"
   "......#...#.........#.............#...#.....#......"
   "###########.........#...........#############......"
   "#.....#.............#...........#.#...#............"
   "#.....#.............#...........#.#######.........."
   "#.....#.............#...........#.....#.#.........."
   "#.....#.............#.....^############.#.........."
   "#.....#.............#...........#.......#.........."
   "#.....#.............#############.......#.........."
   "#.....#.................................#.........."
   "#######.................................#.........."
   "........................................#.........."
   "........................................#.........."
   "........................................#.........."
   "........................................#.........."
   "........................................#.........."
   "............................#############.........."
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#......................"
   "............................#######................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"
   "..................................#................"])
